<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AIDesigner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            background: #ffffff;
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e1e4e8;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            color: #586069;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: #0366d6;
            border-bottom-color: #0366d6;
            background: #ffffff;
        }

        .tab-btn:hover:not(.active) {
            color: #24292e;
            background: #f1f3f4;
        }

        /* Tab Content */
        .tab-content {
            flex: 1;
            display: none;
            padding: 16px;
            overflow-y: auto;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Common Elements */
        .section {
            margin-bottom: 20px;
        }

        .section h3 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #24292e;
        }

        .btn {
            background: #0366d6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
            width: 100%;
            margin-bottom: 8px;
        }

        .btn:hover:not(:disabled) {
            background: #0256cc;
        }

        .btn:disabled {
            background: #8c959f;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #24292e;
            border: 1px solid #d1d5da;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #f8f9fa;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 10px;
            width: auto;
            margin: 0 4px 0 0;
        }
.platform-toggle-container {
  margin-bottom: 16px;
}

.toggle-label {
  display: block;
  font-weight: 600;
  font-size: 12px;
  margin-bottom: 8px;
  color: #374151;
}

.toggle-buttons {
  display: flex;
  gap: 8px;
}

.toggle-btn {
  flex: 1;
  padding: 8px 16px;
  border: 1px solid #d1d5db;
  background: white;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  color: #6b7280;
}

.toggle-btn:hover {
  background: #f9fafb;
  border-color: #9ca3af;
}

.toggle-btn.active {
  background: #dbeafe;
  color: #1d4ed8;
  border-color: #3b82f6;
  font-weight: 600;
}
        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 4px;
            color: #24292e;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5da;
            border-radius: 4px;
            font-size: 12px;
            resize: vertical;
        }

        .input-group textarea {
            min-height: 80px;
        }

        /* Status Messages */
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            margin-bottom: 12px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Enhanced Component List */
        .stats-bar {
            display: flex;
            gap: 16px;
            padding: 8px 12px;
            background: #f1f3f4;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 11px;
        }

        .stat {
            color: #586069;
        }

        .stat-value {
            font-weight: 600;
            color: #24292e;
        }

        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .filter-input {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #d1d5da;
            border-radius: 3px;
            font-size: 11px;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5da;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            color: #586069;
        }

        .filter-btn.active {
            background: #0366d6;
            color: white;
            border-color: #0366d6;
        }

        .component-list {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            min-height: 200px;
        }

        .component-item {
            padding: 12px;
            border-bottom: 1px solid #e1e4e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .component-item:hover {
            background: #f8f9fa;
        }

        .component-item:last-child {
            border-bottom: none;
        }

        .component-info {
            flex: 1;
            min-width: 0;
        }

        .component-name {
            font-weight: 600;
            font-size: 12px;
            color: #24292e;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .component-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .type-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
        }

        .type-select {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #d1d5da;
            border-radius: 3px;
            background: white;
            font-size: 11px;
            color: #586069;
            cursor: pointer;
        }

        .type-select:focus {
            border-color: #0366d6;
            box-shadow: 0 0 0 2px rgba(3, 102, 214, 0.2);
            outline: none;
        }

        .type-select option {
            padding: 4px 8px;
        }

        .confidence-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 500;
            min-width: 35px;
            text-align: center;
        }

        .confidence-high {
            background: #d4edda;
            color: #155724;
        }

        .confidence-medium {
            background: #fff3cd;
            color: #856404;
        }

        .confidence-low {
            background: #f8d7da;
            color: #721c24;
        }

        .confidence-verified {
            background: #d1ecf1;
            color: #0c5460;
        }

        .component-actions {
            display: flex;
            gap: 4px;
            margin-left: 8px;
        }

        .btn-action {
            padding: 4px 8px;
            border: 1px solid #d1d5da;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            color: #586069;
            transition: all 0.2s;
        }

        .btn-action:hover {
            background: #f8f9fa;
            border-color: #0366d6;
            color: #0366d6;
        }

        .page-info {
            font-size: 9px;
            color: #959da5;
            margin-left: 8px;
        }

        .status-icon {
            font-size: 10px;
            margin-right: 4px;
        }

        .icon-verified {
            color: #28a745;
        }

        .icon-auto {
            color: #0366d6;
        }

        .icon-unknown {
            color: #d73a49;
        }

        .context-bar {
            background: #f8f9fa;
            padding: 8px 16px;
            border-bottom: 1px solid #e1e4e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
        }

        .context-info {
            color: #586069;
        }

        .generation-area {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .button-row {
            display: flex;
            gap: 8px;
        }

        .button-row .btn {
            margin-bottom: 0;
        }

        .scan-status {
            background: #f8f9fa;
            border: 1px solid #e1e4e8;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .scan-status.loaded {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .scan-status-text {
            font-size: 11px;
            color: #24292e;
            margin-bottom: 8px;
        }

        .hidden {
            display: none;
        }
        
        .image-upload-area {
            border: 2px dashed #d1d5da;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
            margin-bottom: 16px;
        }

        .image-upload-area:hover {
            border-color: #0366d6;
        }

        .image-upload-area.has-image {
            border-style: solid;
            border-color: #28a745;
            padding: 10px;
        }

        .upload-prompt {
            color: #586069;
            font-size: 12px;
        }

        .image-preview {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }
        .image-preview button {
            margin-top: 8px;
        }

        .iteration-context {
            border: 1px solid #d1ecf1;
            background: #f1f8ff;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .current-design-info h4 {
            font-size: 12px;
            font-weight: 600;
            color: #0366d6;
            margin: 0 0 8px 0;
        }
        .current-design-info h4 span {
            font-weight: 500;
            color: #24292e;
        }
        .modification-history {
            max-height: 80px;
            overflow-y: auto;
            font-size: 10px;
            color: #586069;
            margin-bottom: 10px;
            padding-left: 15px;
        }
        .modification-history li {
            margin-bottom: 4px;
        }
        .iteration-controls {
            display: flex;
            gap: 8px;
        }

        /* NEW: Session Modal Styles */
        .session-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .session-modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
        }

        .session-modal-content {
            position: relative;
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 360px;
            width: calc(100% - 32px);
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .session-modal-header h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
            color: #24292e;
        }

        .session-modal-header p {
            margin: 0 0 16px 0;
            font-size: 12px;
            color: #586069;
        }

        .session-info {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .session-detail {
            margin-bottom: 8px;
            font-size: 11px;
        }

        .session-detail strong {
            color: #24292e;
            display: inline-block;
            min-width: 80px;
        }

        .session-detail span {
            color: #586069;
        }

        #sessionHistoryList {
            margin: 4px 0 0 0;
            padding-left: 16px;
            font-size: 10px;
            color: #586069;
            max-height: 60px;
            overflow-y: auto;
        }

        #sessionHistoryList li {
            margin-bottom: 2px;
        }

        .session-modal-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .session-modal-actions .btn {
            margin-bottom: 0;
        }

        .session-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .session-item {
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .session-item:hover {
            background: #f8f9fa;
            border-color: #0366d6;
        }

        .session-item.current-file {
            border-color: #28a745;
            background: #f1f8ff;
        }

        .session-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .session-file-name {
            font-weight: 600;
            font-size: 12px;
            color: #24292e;
        }

        .session-time {
            font-size: 10px;
            color: #586069;
        }

        .session-item-details {
            font-size: 10px;
            color: #586069;
        }

        .session-item-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }

        .session-item-actions .btn {
            padding: 4px 8px;
            font-size: 10px;
            margin: 0;
            flex: 1;
        }

        .current-file-badge {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 500;
        }
        .toggle-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #f3f4f6;
    color: #9ca3af;
}
    </style>
</head>
<body>
    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('design-system')">🔍 Design System</button>
        <button class="tab-btn" onclick="switchTab('api-settings')">⚙️ API Settings</button>
        <button class="tab-btn" onclick="switchTab('ai-generator')" id="generatorTab" disabled>💬 AI Generator</button>
    </div>

    <!-- Session Restoration Modal -->
    <div class="session-modal" id="sessionModal" style="display: none;">
        <div class="session-modal-backdrop" onclick="closeSessionModal()"></div>
        <div class="session-modal-content">
            <div class="session-modal-header">
                <h3>🔄 Found Previous Work</h3>
                <p>There's unfinished design work in this file</p>
            </div>
            
            <div class="session-modal-body">
                <div class="session-info">
                    <div class="session-detail">
                        <strong>Frame:</strong> <span id="sessionFrameName"></span>
                    </div>
                    <div class="session-detail">
                        <strong>Last modified:</strong> <span id="sessionLastModified"></span>
                    </div>
                    <div class="session-detail">
                        <strong>History:</strong> 
                        <ul id="sessionHistoryList"></ul>
                    </div>
                </div>
            </div>
            
            <div class="session-modal-actions">
                <button class="btn" onclick="restoreSession()">📂 Continue Work</button>
                <button class="btn btn-secondary" onclick="startNewSession()">🗂️ Start Fresh</button>
                <button class="btn btn-secondary btn-small" onclick="showAllSessions()">👁️ All Sessions</button>
            </div>
        </div>
    </div>

    <!-- All Sessions Modal -->
    <div class="session-modal" id="allSessionsModal" style="display: none;">
        <div class="session-modal-backdrop" onclick="closeAllSessionsModal()"></div>
        <div class="session-modal-content">
            <div class="session-modal-header">
                <h3>📁 All Active Sessions</h3>
                <p>Select a session to view or manage</p>
            </div>
            
            <div class="session-modal-body">
                <div class="session-list" id="allSessionsList">
                    <!-- Dynamically generated by JS -->
                </div>
            </div>
            
            <div class="session-modal-actions">
                <button class="btn btn-secondary" onclick="closeAllSessionsModal()">❌ Close</button>
            </div>
        </div>
    </div>

    <!-- Tab 1: Design System -->
    <div class="tab-content active" id="design-system">
        <div class="scan-status" id="scanStatusContainer">
            <div class="scan-status-text" id="scanStatusText">No design system scanned yet</div>
            <button class="btn btn-secondary btn-small" onclick="rescanDesignSystem()" id="rescanBtn" style="display: none;">🔄 Re-scan</button>
        </div>

        <div class="section">
            <h3>Scan Components</h3>
            <button class="btn" onclick="scanDesignSystem()" id="scanBtn">🔍 Scan Design System</button>
        </div>

        <div class="section" id="componentsSection" style="display: none;">
            <h3>Found Components</h3>
            
            <div class="stats-bar" id="statsBar">
                <div class="stat">Total: <span class="stat-value" id="totalCount">0</span></div>
                <div class="stat">High confidence: <span class="stat-value" id="highConfCount">0</span></div>
                <div class="stat">Need review: <span class="stat-value" id="lowConfCount">0</span></div>
                <div class="stat">Verified: <span class="stat-value" id="verifiedCount">0</span></div>
            </div>

            <div class="filter-bar">
                <input type="text" class="filter-input" placeholder="Search components..." id="searchInput">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="unknown">Unknown</button>
                <button class="filter-btn" data-filter="low">Low Conf</button>
                <button class="filter-btn" data-filter="verified">Verified</button>
            </div>
            
            <div class="component-list" id="componentsList"></div>
        </div>

        <div class="section" id="promptSection" style="display: none;">
            <h3>LLM Prompt</h3>
            <button class="btn btn-secondary" onclick="generateLLMPrompt()">📋 Generate & Copy Prompt</button>
        </div>
    </div>

    <!-- Tab 2: API Settings -->
    <div class="tab-content" id="api-settings">
        <div class="section">
            <h3>Gemini API Configuration</h3>
            <div class="input-group">
                <label for="apiKey">API Key:</label>
                <input type="password" id="apiKey" placeholder="Enter your Gemini API key">
            </div>
            <button class="btn" onclick="saveApiKey()" id="saveBtn">💾 Save API Key</button>
        </div>

        <div class="section">
            <h3>Connection Test</h3>
            <button class="btn btn-secondary" onclick="testGeminiConnection()" id="testBtn">🔌 Test Connection</button>
            <div id="connectionStatus"></div>
        </div>

        <div class="section">
            <h3>Debug Options</h3>
            <button class="btn btn-secondary btn-small" onclick="clearAllData()">🗑️ Clear All Data</button>
        </div>
    </div>

    <!-- Tab 3: AI Generator -->
    <div class="tab-content" id="ai-generator">
        <div class="context-bar" id="contextBar">
            <span class="context-info" id="currentContext">Ready for new UI</span>
            <button class="btn btn-secondary btn-small" onclick="startFresh()" id="resetBtn">🗂️ New UI</button>
        </div>

        <!-- Iteration Context Area -->
        <div class="iteration-context" id="iterationContext" style="display: none;">
            <div class="current-design-info">
                <h4>Modifying: <span id="currentDesignName"></span></h4>
                <ul class="modification-history" id="modHistory">
                    <li>Original design generated.</li>
                </ul>
            </div>
            <div class="iteration-controls">
                <button class="btn btn-secondary btn-small" onclick="viewCurrentDesignJSON()">👁️ View Current JSON</button>
                <button class="btn btn-secondary btn-small" onclick="resetToOriginal()">↩️ Reset to Original</button>
            </div>
        </div>
    <!-- INSERT PLATFORM TOGGLE HERE -->
    <div class="platform-toggle-container">
        <label class="toggle-label">Platform:</label>
        <div class="toggle-buttons">
            <button id="mobile-toggle" class="toggle-btn active" data-platform="mobile" onclick="setActivePlatform('mobile')">
                📱 Mobile
            </button>
            <button id="desktop-toggle" class="toggle-btn" data-platform="desktop" disabled>
                🖥️ Desktop <span style="font-size: 9px; opacity: 0.7;">(Soon)</span>
            </button>
        </div>
    </div>
    <!-- END PLATFORM TOGGLE -->
        <!-- Image Upload Section -->
        <div class="section">
            <h3>Reference Image (Optional)</h3>
            <div class="image-upload-area" id="imageUploadArea">
                <input type="file" id="imageInput" accept="image/jpeg, image/png, image/webp, image/gif" style="display: none;">
                <div class="upload-prompt" id="uploadPrompt">
                    📷 Click to upload or drag & drop a reference image
                </div>
                <div class="image-preview" id="imagePreview" style="display: none;">
                    <img id="previewImg" style="max-width: 100%; max-height: 150px; border-radius: 4px;">
                    <button class="btn btn-secondary btn-small" onclick="clearImageSelection()">❌ Remove Image</button>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="generation-area">
                <div class="input-group">
                    <label for="userPrompt" id="userPromptLabel">Describe the UI you want to create:</label>
                    <textarea id="userPrompt" placeholder="create a login form with email and password fields..."></textarea>
                </div>
                
                <div class="button-row">
                    <button class="btn" onclick="generateWithGemini()" id="generateBtn">🪄 Generate UI</button>
                </div>
            </div>
        </div>

        <div id="generationStatus"></div>

        <!-- JSON Debug Section -->
        <div class="section" id="jsonDebugSection" style="display: none;">
            <h3>Generated JSON</h3>
            <div class="button-row">
                <button class="btn btn-secondary btn-small" onclick="copyGeneratedJSON()">📋 Copy JSON</button>
                <button class="btn btn-secondary btn-small" onclick="toggleJSONView()">👁️ Show/Hide</button>
            </div>
            <pre id="jsonOutput" style="display: none; background: #f6f8fa; border: 1px solid #d1d5da; border-radius: 4px; padding: 12px; font-size: 11px; overflow-x: auto; max-height: 300px; overflow-y: auto; font-family: 'Monaco', 'Consolas', monospace;"></pre>
        </div>

        <!-- Manual JSON input as fallback -->
        <div class="section" style="margin-top: 32px; border-top: 1px solid #e1e4e8; padding-top: 16px;">
            <h3>Manual Mode (Fallback)</h3>
            <div class="input-group">
                <label for="jsonInput">Paste JSON directly:</label>
                <textarea id="jsonInput" placeholder='{"layoutContainer": {...}, "items": [...]}'></textarea>
            </div>
            <button class="btn btn-secondary" onclick="generateFromJSON()">📄 Generate from JSON</button>
        </div>
    </div>

    <!-- Load pattern intelligence before main script -->
    <script src="component-patterns.js"></script>
    
    <!-- EMBEDDED PROMPT GENERATOR CLASS -->
    <script>
        if(typeof window!=="undefined"&&window.PatternDetector);else if(typeof require!=="undefined"){const{PatternDetector:e}=require("./component-patterns.js")}class AIDesignerPromptGenerator{constructor(){this.basePersonality=this.buildUXExpertPersonality()}generatePrompt(e,t=[],s=[],i=!1){if(i)var n=this.generateImageAnalysisPrompt(e,t);else{const s=this.preprocessForCommonIssues(e),i=this.buildExpertSystemPrompt(t),o=this.generateContextualGuidance(s),r=this.enhanceUserRequest(s,o);var n={systemPrompt:i,userPrompt:r,fullPrompt:`${i}\n\n${r}\n\nRespond ONLY with valid JSON, without any additional text, comments, or markdown.`,guidance:o}}if("undefined"!=typeof PatternDetector){const t=PatternDetector.detect(e);t.length>0&&(n.userPrompt+=PatternDetector.generateGuidance(t,e),n.fullPrompt=`${n.systemPrompt}\n\n${n.userPrompt}\n\nRespond ONLY with valid JSON, without any additional text, comments, or markdown.`)}return n}generateModificationPrompt(e,t,s){const i=this.buildModificationSystemPrompt(t,e,s);return{systemPrompt:"",userPrompt:"",fullPrompt:`${i}\n\nRespond ONLY with valid JSON, without any additional text, comments, or markdown.`,guidance:[]}}buildModificationSystemPrompt(e,t,s){const i=this.analyzeAvailableComponents(s),n=this.buildDesignSystemContext(i);return`You are an expert UX Designer modifying an existing UI design based on a user's request.

## Your Task:
Modify the "CURRENT DESIGN" JSON structure according to the "USER REQUEST". Return the COMPLETE, new JSON structure.

${n}

---

## CURRENT DESIGN:
\`\`\`json
${JSON.stringify(e,null,2)}
\`\`\`

---

## USER REQUEST:
"${t}"

---

## MODIFICATION RULES (MANDATORY):
1.  **Preserve Unchanged Elements:** Keep ALL elements and properties that were not mentioned in the user request exactly as they are in the "CURRENT DESIGN". Do not alter or remove them.
2.  **Maintain Component IDs:** For all unchanged components, you MUST use the same \`componentNodeId\` as in the original JSON.
3.  **Apply Specific Changes:** Only modify, add, or remove the elements and properties that the user explicitly requested.
4.  **Logical Placement:** When adding new items, place them in a logical position relative to other elements.
5.  **Return Full Structure:** Your final output must be the ENTIRE JSON object, including both the modified and the preserved parts.

## 🔧 VARIANT MODIFICATION RULES:
- **When modifying variants**: Always include the complete variants object with ALL required properties
- **For leading/trailing icons**: Use "Leading": "Icon" and "Trailing": "Icon"
- **For removing icons**: Use "Leading": "None" and "Trailing": "None"  
- **Always validate**: Ensure all variant combinations are complete and valid

## ✅ CORRECT Variant Modification Example:
\`\`\`json
{
  "type": "list-item",
  "componentNodeId": "10:123",
  "properties": {
    "text": "Settings item",
    "horizontalSizing": "FILL",
    "variants": {
      "Condition": "1-line",
      "Leading": "Icon",
      "Trailing": "Icon"
    }
  }
}
\`\`\`

${this.getJSONStructureGuide()}
`}generateImageAnalysisPrompt(e,t){console.log("🖼️ Generating image analysis prompt.");const s=this.analyzeAvailableComponents(t),i=this.buildDesignSystemContext(s),n=`${this.basePersonality}

## 🖼️ IMAGE ANALYSIS TASK

You are analyzing a UI screenshot, wireframe, or mockup. Your expert UX designer skills allow you to:

1.  **Understand Layout Patterns**: Identify how elements are arranged (vertical stack, horizontal sections, grid, etc.).
2.  **Map UI Components**: Recognize buttons, inputs, cards, text, images, and other common UI elements.
3.  **Read Visual Hierarchy**: Understand what's primary vs. secondary content based on size, position, and emphasis.
4.  **Extract Information Architecture**: See how content is grouped and organized into logical sections.

${i}

## 🎯 Your Task:
Analyze the provided user interface image and the user's text request. Your goal is to recreate a similar layout and structure using the available components from the design system.

${this.getJSONStructureGuide()}

## 🧠 Image Analysis Guidelines:
- Focus on the **LAYOUT, STRUCTURE, and HIERARCHY** of the image, not the exact colors, fonts, or pixel-perfect styling.
- **Map the visual elements** in the image to the most appropriate components available in the design system.
- If the user provides a text prompt, it **overrides or clarifies** the image. For example, if the image shows a "Sign Up" button but the user asks for a "Login" page, you should create a login page.
- Maintain the same **information hierarchy and grouping** you see in the image.
- Use nested \`layoutContainer\`s to represent columns, rows, and grouped sections from the image.
- Infer appropriate **spacing and padding** based on the visual relationships in the image.

${this.getJSONExamples()}

## User's Request:
${e||"Recreate the layout from the provided image."}`;return{systemPrompt:"",userPrompt:"",fullPrompt:`${n}\n\nRespond ONLY with valid JSON, without any additional text, comments, or markdown.`,guidance:[]}}buildExpertSystemPrompt(e){const t=this.analyzeAvailableComponents(e),s=this.buildDesignSystemContext(t);return`${this.basePersonality}

${s}

${this.getJSONStructureGuide()}

${this.getUXPrinciples()}

${this.getJSONExamples(e)}`}buildUXExpertPersonality(){return`You are an experienced Senior UX Designer with 10+ years of experience in creating interfaces for web and mobile applications. You have deep knowledge in:

## Your Expertise:
- **User Experience Design**: You understand user needs and create intuitive interfaces
- **Information Architecture**: You can structure content logically and clearly
- **Interaction Design**: You know how to create smooth and effective interactions
- **Accessibility**: You always consider the needs of users with disabilities
- **Design Systems**: You understand the importance of consistency and scalability
- **Mobile & Responsive Design**: Expert in adaptive and mobile-first approaches
- **Modern UI Patterns**: You know modern trends and best practices (Material Design, Human Interface Guidelines, etc.)

## Your Approach:
- Always ask yourself "Why?" before creating something
- Think about the entire user journey, not just a single screen
- Balance aesthetics with functionality
- Consider technical limitations, but don't let them constrain the UX
- Create interfaces that "breathe" - with proper spacing and hierarchy

## Your Task:
Create structured JSON to generate UI in Figma, using components from the user's design system. Apply your UX knowledge to create logical, user-friendly, and beautiful interfaces.`}preprocessForCommonIssues(e){const t=[];return/upload.*button|button.*upload|form.*file.*submit/i.test(e)&&t.push("Keep submit/send buttons as separate items in the main items array, NOT nested inside upload containers"),/captcha.*button|verification.*submit/i.test(e)&&t.push("CAPTCHA sections and submit buttons must be separate objects in the items array"),t.length>0?e+'\n\n// ⚠️ CRITICAL WARNINGS:\n'+t.map(e=>`// - ${e}`).join("\n"):e}analyzeAvailableComponents(e){if(!e||0===e.length)return{byType:{},isEmpty:!0};const t={},s={};return e.forEach(e=>{e.confidence>=.7||e.isVerified?(t[e.suggestedType]||(t[e.suggestedType]=[]),t[e.suggestedType].push(e),s[e.suggestedType]={hasVariants:!(!e.variants||!e.variants.length>0),hasTextLayers:!(!e.textLayers||!e.textLayers.length>0),variants:e.variants||[],variantDetails:e.variantDetails||{},textLayers:e.textLayers||[]}):void 0}),{byType:t,capabilities:s,totalCount:Object.keys(t).length,isEmpty:!1}}buildDesignSystemContext(e){if(e.isEmpty)return`## Available Components:
*Design system not loaded. Please scan your design system first.*
    
IMPORTANT: You cannot use placeholder IDs. Each component must have a real componentNodeId from the scanned design system.`;let t=`## Your Design System (${e.totalCount} component types):
    
*As a Senior UX Designer, you understand that this design system is your tool for creating a consistent experience. Use components wisely, considering their purpose and capabilities.*
    
**CRITICAL**: You MUST use the exact componentNodeId values provided below. Do NOT use placeholder IDs like "button_id" or "input_id_1".
    
`;const s=this.groupComponentsByUXPurpose(e.byType);return Object.entries(s).forEach(([s,i])=>{if(i.length>0){t+=`### ${s}\n`,i.forEach(s=>{const i=e.capabilities[s.suggestedType];t+=`- **${s.suggestedType}** → Use componentNodeId: "${s.id}"`,i?.variantDetails&&Object.keys(i.variantDetails).length>0?(t+="\n  - Variants available:\n",Object.entries(i.variantDetails).forEach(([e,s])=>{t+=`    - ${e}: [${s.map(e=>`"${e}"`).join(", ")}]\n`;const i=e.toLowerCase();i.includes("condition")||i.includes("layout")?t+=`      💡 Layout control: ${s.includes("1-line")?'"1-line" = single line, ':""}${s.includes("2-line")?'"2-line" = detailed view':""}\n`:i.includes("leading")||i.includes("start")?t+="      💡 Leading element: \"Icon\" = shows leading icon, \"None\" = text only\n":i.includes("trailing")||i.includes("end")?t+="      💡 Trailing element: \"Icon\" = shows trailing icon/chevron, \"None\" = no trailing element\n":i.includes("state")||i.includes("status")?t+="      💡 Component state: controls enabled/disabled/selected appearance\n":i.includes("size")?t+="      💡 Size control: affects padding, text size, and touch targets\n":(i.includes("type")||i.includes("style")||i.includes("emphasis"))&&(t+="      💡 Visual emphasis: controls hierarchy and visual weight\n")}),t+="\n  - ⚡ QUICK VARIANT GUIDE:\n",t+='    - "single line" request → use "Condition": "1-line"\n',t+='    - "with icon" request → use "Leading": "Icon"\n',t+='    - "arrow" or "chevron" → use "Trailing": "Icon"\n',t+='    - "simple" or "minimal" → omit variants to use defaults\n',t+="    - Only specify variants you want to change from defaults\n"):i?.hasVariants&&(t+=` - Variants: ${i.variants.join(", ")}`),i?.hasTextLayers&&(t+=`  - Text layers: ${i.textLayers.map(e=>`"${e}"`).join(", ")}`),t+="\n"}),t+="\n"}}),t+=`**Remember**: Always use the exact componentNodeId values listed above. Never use placeholder IDs.

## ✅ CORRECT JSON Example (List Item):
\`\`\`json
{
  "layoutContainer": { "name": "Settings", "layoutMode": "VERTICAL", "width": 360, "itemSpacing": 8 },
  "items": [
    { 
      "type": "list-item", 
      "componentNodeId": "${this.getExampleId(e,"list-item")}", 
      "properties": {
        "text": "Change language",
        "supporting-text": "Select your preferred language",
        "trailing-text": "English",
        "horizontalSizing": "FILL"
      } 
    }
  ]
}
\`\`\`

## 🎯 Property Name Guidelines:
- **Main content**: Use \`"text"\` or \`"headline"\`
- **Secondary content**: Use \`"supporting-text"\` or \`"subtitle"\`  
- **End content**: Use \`"trailing-text"\` or \`"value"\`
- **Never use**: Property names with spaces unless they match exact text layer names
    
## ❌ WRONG - Never use these:
- "input_id", "input_id_1", "button_id" (placeholder IDs)
- "component_123" (made-up IDs)`,t}groupComponentsByUXPurpose(e){const t={"🎯 User Actions":[],"📝 Data Input":[],"🧭 Navigation":[],"📋 Content Display":[],"💬 Feedback":[],"📐 Page Structure":[]},s={"🎯 User Actions":["button","fab","chip","link","icon-button"],"📝 Data Input":["input","textarea","select","checkbox","radio","switch","slider","searchbar","form","upload"],"🧭 Navigation":["appbar","tab","tabs","breadcrumb","pagination","navigation","sidebar","menu"],"📋 Content Display":["card","list","list-item","avatar","image","text","header","badge","icon"],"💬 Feedback":["snackbar","alert","dialog","modal","progress","skeleton","tooltip"],"📐 Page Structure":["container","grid","divider","spacer","frame"]};return Object.entries(e).forEach(([e,i])=>{let n=!1;for(const[o,r]of Object.entries(s))if(r.includes(e)){t[o].push(...i),n=!0;break}n||t["📐 Page Structure"].push(...i)}),t}generateContextualGuidance(e){const t=[],s=e.toLowerCase();return this.containsKeywords(s,["form","login","register","signin","password","email"])&&t.push("Forms should be simple and clear. Place required fields first, and group related fields."),this.containsKeywords(s,["navigat","menu","tab","section"])&&t.push("Navigation should be intuitive. No more than 7±2 items per level. Indicate the current location."),this.containsKeywords(s,["list","card","item","product"])&&t.push("Lists should have a scannable structure: important information at the top, secondary at the bottom. Ensure sufficient spacing between items."),this.containsKeywords(s,["mobile","phone","adaptive","responsive"])&&t.push("Mobile-first approach: large touch targets (min. 44px), easy thumb access, vertical orientation."),this.containsKeywords(s,["dashboard","panel","stat","analytic"])&&t.push("Dashboards: most important information at the top and left, use progressive disclosure for details."),this.containsKeywords(s,["settings","preferences","account","options","configure"])&&(t.push("Settings screens should show current values for quick reference. Use 'trailing-text' to display current language, phone number, email, notification status, etc."),t.push("Group related settings logically. Show action hints like 'What is it?' for premium features, current values for user data.")),this.containsKeywords(s,["single line","one line","1 line","minimal","simple"])&&t.push('For single line layouts, use "Condition": "1-line" variant.'),this.containsKeywords(s,["two line","double line","2 line","detailed"])&&t.push('For two line layouts, use "Condition": "2-line" variant.'),this.containsKeywords(s,["with icon","show icon","icon before"])&&t.push('To show leading icons, use "Leading": "Icon" variant.'),this.containsKeywords(s,["no icon","without icon","text only"])&&t.push('To hide icons, use "Leading": "None" variant.'),this.containsKeywords(s,["trailing","end icon","arrow","chevron"])&&t.push('To show trailing elements, use "Trailing": "Icon" variant.'),t}enhanceUserRequest(e,t){let s=e;return t.length>0&&(s+="\n\n// As an experienced UX designer, consider these principles:",t.forEach(e=>{s+=`\n// - ${e}`})),s+="\n\n// Apply your UX knowledge to create a logical, user-friendly, and aesthetically pleasing interface.",s}getUXPrinciples(){return`## Your UX Principles (always follow them):

### 1. Hierarchy and Importance
- The most important elements are the largest and highest
- Use size, color, and position to create a visual hierarchy
- The primary action (Primary CTA) must be obvious

### 2. Spacing and Breathing Room
- Use consistent spacing: 8px, 16px, 24px, 32px
- Let the content "breathe" - don't cram everything onto one screen
- Group related elements through proximity

### 3. Cognitive Load
- Don't overload the user with options
- Progressive disclosure: show the main things, hide the details
- Make the next steps obvious

### 4. Accessibility
- Minimum touch target size: 44px
- Sufficient contrast for text
- Logical tabbing order

### 5. User Mental Models
- Use familiar patterns (don't reinvent the wheel)
- Place elements where they are expected
- Consistency throughout the entire product`}getJSONStructureGuide(){return`## JSON Structure & Rules:

### Basic structure:
\`\`\`json
{
  "layoutContainer": {
    "name": "Container Name",
    "layoutMode": "VERTICAL",
    "width": 360,           // Always specify width for mobile
    "paddingTop": 24,
    "paddingBottom": 24,
    "paddingLeft": 16,
    "paddingRight": 16,
    "itemSpacing": 16
  },
  "items": [
    // ... components go here
  ]
}
\`\`\`

### UX Considerations for JSON:
- **layoutMode**: VERTICAL is easier to scan for most content.
- **itemSpacing**: Use 16px for related items, 24px+ for separating sections.
- **horizontalSizing**: "FILL" is crucial for primary actions (buttons) and inputs.
- **items order**: This defines the visual and accessibility order. Top-to-bottom matters.

### Component Selection Rules:
- **ALWAYS use the exact componentNodeId from the design system list above**
- Never use placeholder IDs like "button_id", "input_id", etc.
- File upload areas: Use layoutContainer with icon + text, NOT image component
- Secondary buttons: Use button with variants like "Medium" emphasis
- CAPTCHA/forms: Use input or form components, NOT list-item
- All form inputs: Must have horizontalSizing: "FILL"
- Icon actions: Use icon-button if available, or button with icon property

### Text Property Rules:
- **Primary text**: Use \`"text"\` or \`"headline"\` for main content
- **Secondary text**: Use \`"supporting-text"\` for descriptions
- **Action/Value text**: Use \`"trailing-text"\` for status, values, or action hints
- **Property names should be lowercase with hyphens**: \`"supporting-text"\` not \`"Supporting text"\`
- **Avoid variant names as text content**: Don't use \`"Headline": "text content"\`

### Enhanced List Item Example:
\`\`\`json
{
  "type": "list-item",
  "componentNodeId": "10:123",
  "properties": {
    "text": "Change language",           // Main headline
    "supporting-text": "Select your preferred language",  // Optional description
    "trailing-text": "English",   // Current value or action hint
    "horizontalSizing": "FILL",
    "variants": {
      "Condition": "1-line",       // Component variants in separate object
      "Leading": "Icon",
      "Trailing": "Icon"
    }
  }
}
\`\`\`

### Variant Usage Rules:
- **Variants must be in a separate "variants" object inside properties**
- **NEVER mix variants with regular properties at the same level**
- Variant properties are case-sensitive: "Condition" not "condition"
- Variant values are case-sensitive: "1-line" not "1-Line"

### ✅ CORRECT Variant Structure:
\`\`\`json
{
  "type": "list-item",
  "componentNodeId": "10:123",
  "properties": {
    "text": "Personal details",
    "horizontalSizing": "FILL",
    "variants": {
      "Condition": "1-line",
      "Leading": "Icon", 
      "Trailing": "Icon"
    }
  }
}
\`\`\`

### ❌ WRONG - Never do this:
\`\`\`json
{
  "properties": {
    "text": "Personal details",
    "Condition": "1-line",    // WRONG: variants mixed with properties
    "Leading": "Icon"         // WRONG: should be in variants object
  }
}
\`\`\`

### Example with variants:
\`\`\`json
{
  "type": "button",
  "componentNodeId": "10:123",
  "properties": {
    "text": "Submit",
    "horizontalSizing": "FILL",
    "variants": {
      "Type": "Primary",    // Must match exactly from available options
      "Size": "Large",      // Case-sensitive!
      "State": "enabled"    // Default states are usually "enabled" or "default"
    }
  }
}
\`\`\`

### Button Hierarchy:
- Primary actions (Submit, Send): "High" emphasis, horizontalSizing: "FILL"
- Secondary actions (Add more): "Medium" emphasis, horizontalSizing: "AUTO"
- Icon actions: icon-button or button with icon

### CRITICAL OBJECT SEPARATION RULES:
Each item in the "items" array must be a complete, separate object.

✅ CORRECT - Separate objects:
\`\`\`json
{
  "items": [
    { 
      "type": "layoutContainer",
      "name": "Section1",
      "items": []
    },
    { 
      "type": "button",
      "componentNodeId": "10:3907",  // Real ID from design system
      "properties": {}
    }
  ]
}
\`\`\`

❌ WRONG - Placeholder IDs:
\`\`\`json
{
  "items": [
    { 
      "type": "button",
      "componentNodeId": "button_id",  // NEVER use placeholder IDs!
      "properties": {}
    }
  ]
}
\`\`\``}getJSONExamples(e){const t=t=>{if(!e||!e.byType||e.isEmpty)return`${t}_actual_id`;const s=e.byType[t];return s&&Array.isArray(s)&&s.length>0?s[0].id:`${t}_actual_id`},s=t("header"),i=t("input"),n=t("button"),o=t("text"),r=t("image"),a=t("list-item");return`## Examples (with UX rationale):

### Login Form (classic user flow):
\`\`\`json
{
  "layoutContainer": {
    "name": "Login Form",
    "layoutMode": "VERTICAL",
    "width": 360,
    "paddingTop": 32,
    "paddingBottom": 32,
    "paddingLeft": 24,
    "paddingRight": 24,
    "itemSpacing": 20
  },
  "items": [
    { "type": "header", "componentNodeId": "${s}", "properties": {"text": "Sign In"} },
    { "type": "input", "componentNodeId": "${i}", "properties": {"text": "Email", "horizontalSizing": "FILL"} },
    { "type": "input", "componentNodeId": "${i}", "properties": {"text": "Password", "horizontalSizing": "FILL"} },
    { 
    "type": "button", 
    "componentNodeId": "${n}", 
    "properties": {
        "text": "Sign In", 
        "horizontalSizing": "FILL",
        "variants": {
            "State": "enabled",
            "Style": "selected"
        }
    } 
}
  ]
}
\`\`\`
*UX decision: A title for context, full-width inputs for easy tapping, and the primary action button at the bottom for a natural flow.*

### Complex Form with File Upload and Submit Button:
\`\`\`json
{
  "layoutContainer": {
    "name": "Upload Form",
    "layoutMode": "VERTICAL",
    "width": 360,
    "paddingTop": 24,
    "paddingBottom": 24,
    "paddingLeft": 16,
    "paddingRight": 16,
    "itemSpacing": 16
  },
  "items": [
    { "type": "header", "componentNodeId": "${s}", "properties": {"text": "Upload Documents"} },
    {
      "type": "layoutContainer",
      "name": "FileUploadSection",
      "items": [
        { "type": "text", "componentNodeId": "${o}", "properties": {"text": "Upload your file"} },
        { "type": "image", "componentNodeId": "${r}", "properties": {"icon": "upload"} }
      ]
    },
    {
      "type": "layoutContainer",
      "name": "CaptchaSection",
      "items": [
        { "type": "text", "componentNodeId": "${o}", "properties": {"text": "CAPTCHA placeholder"} }
      ]
    },
    {
      "type": "button",
      "componentNodeId": "${n}",
      "properties": { "text": "Submit", "horizontalSizing": "FILL" }
    }
  ]
}
\`\`\`
*UX decision: Each major section (file upload, captcha, submit button) is a separate item in the main "items" array. The submit button is NOT nested inside any other container.*

### Settings Screen with Smart Variants:
\`\`\`json
{
  "layoutContainer": {
    "name": "Settings Screen",
    "layoutMode": "VERTICAL",
    "width": 360,
    "itemSpacing": 8
  },
  "items": [
    {
      "type": "list-item",
      "componentNodeId": "${a}",
      "properties": {
        "text": "Personal details",
        "horizontalSizing": "FILL",
        "variants": {
          "Condition": "1-line"
        }
      }
    },
    {
      "type": "list-item",
      "componentNodeId": "${a}",
      "properties": {
        "text": "Change language",
        "trailing-text": "English",
        "horizontalSizing": "FILL",
        "variants": {
          "Condition": "2-line",
          "Trailing": "Icon"
        }
      }
    }
  ]
}
\`\`\`
*UX Note: You only need to specify variants you want to change. The plugin automatically fills in defaults for other variant properties.*

**IMPORTANT**: Notice how we use the actual componentNodeId values from your design system, NOT placeholder IDs.`}getExampleId(e,t){if(!e||!e.byType||e.isEmpty)return`${t}_actual_id`;const s=e.byType[t];return s&&Array.isArray(s)&&s.length>0?s[0].id:`${t}_actual_id`}containsKeywords(e,t){return t.some(t=>e.includes(t))}}
"undefined"!=typeof window&&(window.AIDesignerPromptGenerator=AIDesignerPromptGenerator);
    </script>
    
    <!-- Load bundled UI modules -->
    <script src="ui-bundle.js"></script>

    <!-- Minimal compatibility layer -->
    <script>
        // Platform toggle functions for backward compatibility
        function setActivePlatform(platform) {
            if (window.StateManager) {
                window.StateManager.setState('currentPlatform', platform);
            }
            
            // Update button states
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const platformBtn = document.getElementById(platform + '-toggle');
            if (platformBtn) {
                platformBtn.classList.add('active');
            }
            
            console.log('Platform switched to:', platform);
        }

        // Global wrapper functions for UI features
        window.scanDesignSystem = function() {
            if (window.aidesignerApp) {
                const designSystemFeature = window.aidesignerApp.getFeature('designSystem');
                if (designSystemFeature && designSystemFeature.scanDesignSystem) {
                    designSystemFeature.scanDesignSystem();
                }
            }
        };

        window.rescanDesignSystem = function() {
            if (window.aidesignerApp) {
                const designSystemFeature = window.aidesignerApp.getFeature('designSystem');
                if (designSystemFeature && designSystemFeature.rescanDesignSystem) {
                    designSystemFeature.rescanDesignSystem();
                }
            }
        };
    </script>
</body>
</html>